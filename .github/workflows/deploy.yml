name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  ci:
    uses: ./.github/workflows/ci.yml

  deploy:
    needs: ci
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Login to Azure Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and push backend image
        env:
          ACR_REGISTRY: ${{ secrets.ACR_LOGIN_SERVER }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build \
            -t $ACR_REGISTRY/construction-manager-backend:$IMAGE_TAG \
            -t $ACR_REGISTRY/construction-manager-backend:latest \
            -f backend/Dockerfile backend/
          docker push $ACR_REGISTRY/construction-manager-backend --all-tags

      - name: Build and push frontend image
        env:
          ACR_REGISTRY: ${{ secrets.ACR_LOGIN_SERVER }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build \
            -t $ACR_REGISTRY/construction-manager-frontend:$IMAGE_TAG \
            -t $ACR_REGISTRY/construction-manager-frontend:latest \
            -f frontend/Dockerfile frontend/
          docker push $ACR_REGISTRY/construction-manager-frontend --all-tags

      - name: Deploy to Azure VM
        env:
          ACR_REGISTRY: ${{ secrets.ACR_LOGIN_SERVER }}
          IMAGE_TAG: ${{ github.sha }}
          VM_HOST: ${{ secrets.AZURE_VM_HOST }}
          ACR_USERNAME: ${{ secrets.ACR_USERNAME }}
          ACR_PASSWORD: ${{ secrets.ACR_PASSWORD }}
        run: |
          # Write SSH key
          mkdir -p ~/.ssh
          echo "${{ secrets.AZURE_VM_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "$VM_HOST" >> ~/.ssh/known_hosts 2>/dev/null

          SSH_CMD="ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=accept-new azureuser@${VM_HOST}"

          # Copy updated compose file
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=accept-new docker-compose.prod.yml azureuser@${VM_HOST}:/opt/app/docker-compose.prod.yml

          # ACR login on the server
          $SSH_CMD "docker login ${ACR_REGISTRY} -u ${ACR_USERNAME} -p ${ACR_PASSWORD}"

          # Pull new images
          $SSH_CMD "cd /opt/app && ACR_REGISTRY=${ACR_REGISTRY} IMAGE_TAG=${IMAGE_TAG} docker compose -f docker-compose.prod.yml pull"

          # Restart with new images
          $SSH_CMD "cd /opt/app && ACR_REGISTRY=${ACR_REGISTRY} IMAGE_TAG=${IMAGE_TAG} docker compose -f docker-compose.prod.yml up -d"

          # Wait for backend to be ready, then run migrations
          sleep 10
          $SSH_CMD "cd /opt/app && docker compose -f docker-compose.prod.yml exec -T backend npm run migrate:up"

          # Restart backend to pick up any new tables
          $SSH_CMD "cd /opt/app && docker compose -f docker-compose.prod.yml restart backend"

          # Clean up old images
          $SSH_CMD "docker image prune -f"
